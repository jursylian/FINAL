# Схемы базы данных и связи

[< Назад к содержанию](README.md) | [Далее: Аутентификация >](03-auth-flow.md)

---

## Обзор коллекций

```
MongoDB Database: ichgram
│
├── users              ← Учётные записи
├── posts              ← Публикации с изображениями
├── likes              ← Лайки постов
├── comments           ← Комментарии к постам
├── follows            ← Подписки между пользователями
├── notifications      ← Уведомления о действиях
└── messages           ← Сообщения чата (опционально)
```

---

## Схема связей между коллекциями

```
┌─────────────┐
│    User     │
│─────────────│
│ _id         │◄─────────────────────────────────────────────┐
│ email       │                                              │
│ username    │◄──────────────────────────────┐              │
│ password    │                               │              │
│ name        │         ┌─────────────┐       │              │
│ bio         │         │    Post     │       │              │
│ website     │         │─────────────│       │              │
│ avatar      │         │ _id         │◄──────┼──────┐       │
│ ...         │    ┌───►│ authorId    │───┐   │      │       │
└─────────────┘    │    │ image       │   │   │      │       │
      │            │    │ caption     │   │   │      │       │
      │            │    └─────────────┘   │   │      │       │
      │            │                      │   │      │       │
      │            │    ┌─────────────┐   │   │      │       │
      │            │    │    Like     │   │   │      │       │
      │            │    │─────────────│   │   │      │       │
      ├────────────┼───►│ userId      │───┘   │      │       │
      │            │    │ postId      │───────┘      │       │
      │            │    └─────────────┘              │       │
      │            │                                 │       │
      │            │    ┌─────────────┐              │       │
      │            │    │  Comment    │              │       │
      │            │    │─────────────│              │       │
      ├────────────┼───►│ userId      │──┐           │       │
      │            │    │ postId      │──┼───────────┘       │
      │            │    │ text        │  │                   │
      │            │    │ likes[]     │──┼───────────────────┘
      │            │    └─────────────┘  │     (массив userId)
      │            │                     │
      │            │    ┌─────────────┐  │
      │            │    │   Follow    │  │
      │            │    │─────────────│  │
      ├────────────┼───►│ followerId  │──┘
      │            └───►│ followingId │───► User
      │                 └─────────────┘
      │
      │                 ┌──────────────────┐
      │                 │  Notification    │
      │                 │──────────────────│
      ├────────────────►│ userId           │ (получатель)
      └────────────────►│ actorId          │ (инициатор)
                        │ type             │
                        │ entityId         │───► Post / Comment / User
                        │ read             │
                        └──────────────────┘
```

---

## Детальные схемы коллекций

### User

```
┌──────────────────────────────────────────────────────────────┐
│                          users                               │
├──────────────────────┬───────────┬───────────────────────────┤
│ Поле                 │ Тип       │ Описание                  │
├──────────────────────┼───────────┼───────────────────────────┤
│ _id                  │ ObjectId  │ Автоматический ID         │
│ email                │ String    │ unique, required, lowercase│
│ username             │ String    │ unique, required, 3-30 сим│
│ password             │ String    │ required, min 8, select:false│
│ name                 │ String    │ Отображаемое имя          │
│ bio                  │ String    │ Биография, max 160 символов│
│ website              │ String    │ Ссылка, max 200 символов  │
│ avatar               │ String    │ Base64 Data URL изображения│
│ resetPasswordTokenHash│ String   │ select:false, хеш токена  │
│ resetPasswordExpiresAt│ Date     │ select:false, срок токена  │
│ createdAt            │ Date      │ timestamps                │
│ updatedAt            │ Date      │ timestamps                │
├──────────────────────┴───────────┴───────────────────────────┤
│ Индексы:                                                     │
│   • email (unique)                                           │
│   • username (unique)                                        │
├──────────────────────────────────────────────────────────────┤
│ Middleware:                                                   │
│   • pre('save'): если password изменён → bcrypt.hash(10)     │
│ Методы:                                                      │
│   • comparePassword(candidate) → bcrypt.compare()            │
├──────────────────────────────────────────────────────────────┤
│ select: false:                                               │
│   password, resetPasswordTokenHash, resetPasswordExpiresAt   │
│   Эти поля НЕ включаются в запросы по умолчанию.            │
│   Для доступа: .select('+password')                          │
└──────────────────────────────────────────────────────────────┘
```

**Что означает `select: false`:**

Mongoose по умолчанию возвращает все поля документа. Поля с `select: false` исключаются из результатов всех запросов. Это защита: даже если разработчик забудет вызвать `.select('-password')`, пароль не попадёт в ответ. Для намеренного доступа нужно явно указать `.select('+password')`.

**Что делает `pre('save')` hook:**

```
User.save()
    │
    ▼
pre('save') middleware
    │
    ├── password изменён? ──► Нет ──► пропустить
    │
    └── Да ──► bcrypt.hash(password, 10)
                    │
                    ▼
              password = хеш
                    │
                    ▼
              сохранение в MongoDB
```

### Post

```
┌──────────────────────────────────────────────────────────────┐
│                          posts                               │
├──────────────────────┬───────────┬───────────────────────────┤
│ Поле                 │ Тип       │ Описание                  │
├──────────────────────┼───────────┼───────────────────────────┤
│ _id                  │ ObjectId  │ Автоматический ID         │
│ authorId             │ ObjectId  │ ref: User, required, index│
│ image                │ String    │ required, Base64 Data URL │
│ caption              │ String    │ Подпись, max 2200 символов│
│ createdAt            │ Date      │ timestamps                │
│ updatedAt            │ Date      │ timestamps                │
├──────────────────────┴───────────┴───────────────────────────┤
│ Индексы:                                                     │
│   • authorId                                                 │
│   • createdAt: -1 (сортировка ленты от новых к старым)       │
└──────────────────────────────────────────────────────────────┘
```

**Хранение изображений (Base64):**

```
Клиент                      Сервер                    MongoDB
   │                           │                         │
   │  FormData + image file    │                         │
   ├──────────────────────────►│                         │
   │                           │                         │
   │                    Multer (memoryStorage)           │
   │                    req.file.buffer (Buffer)         │
   │                           │                         │
   │                    toDataUrl(req.file)              │
   │                    "data:image/jpeg;base64,..."     │
   │                           │                         │
   │                           │   image: "data:..."     │
   │                           ├────────────────────────►│
   │                           │                         │
```

**Почему Base64, а не файловое хранилище:**
- Простота: не нужен файловый сервер, CDN, S3
- Для учебного проекта: всё хранится в одном месте
- Ограничение: +33% к размеру, лимит документа MongoDB 16MB

### Like

```
┌──────────────────────────────────────────────────────────────┐
│                          likes                               │
├──────────────────────┬───────────┬───────────────────────────┤
│ Поле                 │ Тип       │ Описание                  │
├──────────────────────┼───────────┼───────────────────────────┤
│ _id                  │ ObjectId  │ Автоматический ID         │
│ userId               │ ObjectId  │ ref: User, required, index│
│ postId               │ ObjectId  │ ref: Post, required, index│
│ createdAt            │ Date      │ timestamps                │
│ updatedAt            │ Date      │ timestamps                │
├──────────────────────┴───────────┴───────────────────────────┤
│ Индексы:                                                     │
│   • { userId: 1, postId: 1 } (unique compound)              │
│                                                              │
│ Уникальный составной индекс гарантирует, что один           │
│ пользователь может лайкнуть один пост только один раз.       │
│ Попытка дублирования вызовет ошибку E11000 (duplicate key).  │
└──────────────────────────────────────────────────────────────┘
```

### Comment

```
┌──────────────────────────────────────────────────────────────┐
│                        comments                              │
├──────────────────────┬───────────┬───────────────────────────┤
│ Поле                 │ Тип       │ Описание                  │
├──────────────────────┼───────────┼───────────────────────────┤
│ _id                  │ ObjectId  │ Автоматический ID         │
│ userId               │ ObjectId  │ ref: User, required, index│
│ postId               │ ObjectId  │ ref: Post, required, index│
│ text                 │ String    │ required, max 500 символов│
│ likes                │ [ObjectId]│ ref: User, массив лайков  │
│ createdAt            │ Date      │ timestamps                │
│ updatedAt            │ Date      │ timestamps                │
├──────────────────────┴───────────┴───────────────────────────┤
│ Индексы:                                                     │
│   • userId                                                   │
│   • postId                                                   │
│   • createdAt: -1                                            │
├──────────────────────────────────────────────────────────────┤
│ Особенность: лайки комментариев хранятся как массив userId   │
│ прямо в документе (embedded pattern), а не в отдельной       │
│ коллекции. Это оправдано: лайков на комментарий обычно мало, │
│ и embedded-массив быстрее для чтения (один запрос).          │
└──────────────────────────────────────────────────────────────┘
```

**Два подхода к лайкам в проекте:**

```
Лайки ПОСТОВ:                       Лайки КОММЕНТАРИЕВ:
Отдельная коллекция (Like)           Embedded массив (Comment.likes[])

┌────────┐   ┌────────┐             ┌────────────────────┐
│ Post   │   │ Like   │             │ Comment            │
│        │◄──│ postId │             │                    │
│        │   │ userId │             │ likes: [userId1,   │
└────────┘   └────────┘             │         userId2]   │
                                    └────────────────────┘

Почему разные подходы:
• Постов лайкают много (тысячи) → отдельная коллекция с индексами
• Комментарии лайкают мало (десятки) → массив в документе быстрее
```

### Follow

```
┌──────────────────────────────────────────────────────────────┐
│                        follows                               │
├──────────────────────┬───────────┬───────────────────────────┤
│ Поле                 │ Тип       │ Описание                  │
├──────────────────────┼───────────┼───────────────────────────┤
│ _id                  │ ObjectId  │ Автоматический ID         │
│ followerId           │ ObjectId  │ ref: User, кто подписался │
│ followingId          │ ObjectId  │ ref: User, на кого        │
│ createdAt            │ Date      │ timestamps                │
│ updatedAt            │ Date      │ timestamps                │
├──────────────────────┴───────────┴───────────────────────────┤
│ Индексы:                                                     │
│   • { followerId: 1, followingId: 1 } (unique compound)     │
│   • followerId                                               │
│   • followingId                                              │
├──────────────────────────────────────────────────────────────┤
│ Направление связи:                                           │
│                                                              │
│   UserA (follower) ──follows──► UserB (following)            │
│                                                              │
│   "UserA подписан на UserB"                                  │
│   followerId = UserA._id                                     │
│   followingId = UserB._id                                    │
│                                                              │
│   Подписчики UserB:  Follow.find({ followingId: UserB._id })│
│   Подписки UserA:    Follow.find({ followerId: UserA._id }) │
└──────────────────────────────────────────────────────────────┘
```

### Notification

```
┌──────────────────────────────────────────────────────────────┐
│                     notifications                            │
├──────────────────────┬───────────┬───────────────────────────┤
│ Поле                 │ Тип       │ Описание                  │
├──────────────────────┼───────────┼───────────────────────────┤
│ _id                  │ ObjectId  │ Автоматический ID         │
│ userId               │ ObjectId  │ ref: User, ПОЛУЧАТЕЛЬ     │
│ actorId              │ ObjectId  │ ref: User, ИНИЦИАТОР      │
│ type                 │ String    │ enum (см. ниже)           │
│ entityId             │ ObjectId  │ ID связанной сущности     │
│ read                 │ Boolean   │ Прочитано? default: false │
│ createdAt            │ Date      │ timestamps                │
│ updatedAt            │ Date      │ timestamps                │
├──────────────────────┴───────────┴───────────────────────────┤
│ Индексы:                                                     │
│   • userId                                                   │
│   • actorId                                                  │
│   • entityId                                                 │
│   • read                                                     │
│   • createdAt: -1                                            │
├──────────────────────────────────────────────────────────────┤
│ Типы уведомлений:                                            │
│                                                              │
│   type            │ entityId указывает на │ Когда создаётся  │
│   ────────────────┼───────────────────────┼──────────────────│
│   "like"          │ Post._id              │ Лайк поста       │
│   "comment"       │ Comment._id           │ Новый комментарий│
│   "follow"        │ User._id (target)     │ Подписка         │
│   "like_comment"  │ Comment._id           │ Лайк комментария │
│                                                              │
│ userId ≠ actorId: уведомление не создаётся для своих действий│
└──────────────────────────────────────────────────────────────┘
```

### Message (опционально, для чата)

```
┌──────────────────────────────────────────────────────────────┐
│                       messages                               │
├──────────────────────┬───────────┬───────────────────────────┤
│ Поле                 │ Тип       │ Описание                  │
├──────────────────────┼───────────┼───────────────────────────┤
│ _id                  │ ObjectId  │ Автоматический ID         │
│ roomId               │ String    │ required, ID диалога      │
│ senderId             │ ObjectId  │ ref: User, отправитель    │
│ text                 │ String    │ required, max 2000 символов│
│ createdAt            │ Date      │ timestamps                │
│ updatedAt            │ Date      │ timestamps                │
├──────────────────────┴───────────┴───────────────────────────┤
│ Индексы:                                                     │
│   • roomId                                                   │
│   • senderId                                                 │
│   • createdAt: -1                                            │
├──────────────────────────────────────────────────────────────┤
│ Статус: модель создана, но функционал чата не реализован.    │
│ Подготовлена для будущей интеграции с Socket.io.             │
└──────────────────────────────────────────────────────────────┘
```

---

## Паттерны хранения данных

### Referencing (ссылки) vs Embedding (вложение)

В проекте используются оба паттерна:

```
Referencing (отдельные коллекции):
─────────────────────────────────
Like, Follow — отдельные коллекции со ссылками на User и Post.
Причина: данные растут неограниченно, нужны индексы для быстрого
поиска и подсчёта, нужна атомарная операция toggle.

Embedding (встроенные данные):
─────────────────────────────
Comment.likes[] — массив ObjectId внутри документа.
Причина: лайков на комментарий обычно мало (< 100),
один запрос вместо двух, проще логика.
```

### Populate vs Aggregate

```
populate() — простые запросы:
───────────────────────────
Post.findById(id).populate("authorId", "username avatar")

Эквивалент SQL: SELECT * FROM posts LEFT JOIN users ON ...
Mongoose делает 2 запроса: один к posts, второй к users.

aggregate() — сложные запросы (лента):
──────────────────────────────────────
Post.aggregate([
  { $match: { authorId: { $in: followingIds } } },
  { $sort: { createdAt: -1 } },
  { $skip: 0 }, { $limit: 20 },
  { $lookup: { from: "users", ... } },      ← аналог JOIN
  { $lookup: { from: "likes", ... } },      ← подсчёт лайков
  { $lookup: { from: "comments", ... } },   ← подсчёт комментариев
  { $addFields: {
      likesCount: { $size: "$likes" },
      commentsCount: { $size: "$comments" }
  }},
  { $project: { likes: 0, comments: 0 } }   ← убрать массивы
])

Один запрос к MongoDB с pipeline обработкой.
Эффективнее для сложных выборок с агрегацией.
```
